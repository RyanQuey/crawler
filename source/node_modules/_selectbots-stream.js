var through = require('through2')

var fs = require('fs')
var path = require('path')

module.exports = makebot

function makebot (botdirectory, extension) {
  var BOTNAMES
  var hasEnded
  var init
  var QUEUE = []
  var BOTS = {}
  function streamAll () {
    BOTNAMES.forEach(function (botname) {
      stream$.push(path.join(botdirectory, botname)+(extension||''))
    })
    end()
  }
  getAllBots(botdirectory, extension, function (botnames) {
    init = true
    BOTNAMES = botnames
    QUEUE.forEach(function (X) {
      var abbrev = X.abbrev
      var push = X.push
      var next = X.next
      isBot(abbrev).forEach(function (botname) {
        if (BOTS[botname]) return
        BOTS[botname] = true
        push(path.join(botdirectory, botname)+(extension||''))
      })
      next()
    })
    if (hasEnded) return stream$.end()
  })
  var stream$ = through.obj(function (chunk, encoding, next) {
    var abbrev = chunk
    var self = this
    if (BOTNAMES) {
      isBot(abbrev).forEach(function (botname) {
        if (BOTS[botname]) return
        BOTS[botname] = true
        self.push(path.join(botdirectory, botname)+(extension||''))
      })
      next()
    } else {
      QUEUE.push({abbrev: chunk, push: self.push.bind(self), next: next })
    }
  })
  var end = stream$.end.bind(stream$)
  stream$.end = function () {
    if (!init) hasEnded = true
    else if (Object.keys(BOTS).length === 0) streamAll()
    else end()
  }
  return stream$
  function isBot (abbreviation) {
    return BOTNAMES.filter(function (name) {
      return name.includes(abbreviation)
    })
  }
}

function getAllBots (dirname, ext, cb) {
  fs.readdir(dirname, loadBots)
  function loadBots (error, botnames) {
    if (error) return cb(error)
    var bots = []
    var counter = botnames.length
    var noerror = true
    botnames.forEach(function (name) {
      var botpath = path.join(dirname, name)
      fs.stat(botpath, function isBot (error, stats) {
        counter--
        if (noerror) {
          if (error) {
            noerror = false
            return cb(error)
          }
          var isFile = stats.isFile()
          var extension = path.extname(name)
          var isType = extension === ext
          if (isFile && isType) bots.push(path.basename(name, ext))
          if (!counter) cb(bots)
        }
      })
    })
  }
}
